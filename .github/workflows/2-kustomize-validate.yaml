name: Validate Manifests & Deploy

on:
  push:
    branches: [main, develop]
    paths:
      - 'k8s/**'
      - '.github/workflows/2-kustomize-validate.yaml'

jobs:
  validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev]

    steps:
      - uses: actions/checkout@v3

      - name: Install Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Kustomize build
        run: kustomize build k8s/overlays/${{ matrix.environment }} --enable-helm > manifests-${{ matrix.environment }}.yaml

      - name: Validate YAML syntax
        run: |
          python3 -c "
          import yaml
          with open('manifests-${{ matrix.environment }}.yaml', 'r') as f:
              yaml.safe_load_all(f)
          print('✓ YAML синтаксис валиден')
          "

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: manifests-${{ matrix.environment }}
          path: manifests-${{ matrix.environment }}.yaml

  validate-cluster:
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.ref == 'refs/heads/main' &&
      secrets.KUBE_CONFIG != '' &&
      secrets.ARGOCD_SERVER != '' &&
      secrets.ARGOCD_TOKEN != ''

    steps:
      - uses: actions/checkout@v3

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: manifests-dev

      - name: Validate with kubectl dry-run
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          kubectl apply -f manifests-dev.yaml --dry-run=client

  argocd-sync:
    runs-on: ubuntu-latest
    needs: validate-cluster
    if: |
      github.ref == 'refs/heads/main' &&
      secrets.KUBE_CONFIG != '' &&
      secrets.ARGOCD_SERVER != '' &&
      secrets.ARGOCD_TOKEN != ''

    steps:
      - name: Trigger Argo CD sync
        env:
          ARGOCD_SERVER: ${{ secrets.ARGOCD_SERVER }}
          ARGOCD_TOKEN: ${{ secrets.ARGOCD_TOKEN }}
        run: |
          argocd app sync mlops-app \
            --server $ARGOCD_SERVER \
            --auth-token $ARGOCD_TOKEN \
            --grpc-web
