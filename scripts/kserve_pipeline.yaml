# PIPELINE DEFINITION
# Name: kserve-mlops-pipeline
# Description: Feast -> MLflow -> KServe
components:
  comp-etl-and-feast-op:
    executorLabel: exec-etl-and-feast-op
    inputDefinitions:
      parameters:
        access_key:
          parameterType: STRING
        minio_url:
          parameterType: STRING
        redis_url:
          parameterType: STRING
        secret_key:
          parameterType: STRING
  comp-kserve-deploy-op:
    executorLabel: exec-kserve-deploy-op
    inputDefinitions:
      parameters:
        model_name:
          defaultValue: iris-classifier
          isOptional: true
          parameterType: STRING
        model_uri:
          parameterType: STRING
        namespace:
          defaultValue: kubeflow
          isOptional: true
          parameterType: STRING
  comp-train-op:
    executorLabel: exec-train-op
    inputDefinitions:
      parameters:
        access_key:
          parameterType: STRING
        minio_url:
          parameterType: STRING
        mlflow_url:
          parameterType: STRING
        secret_key:
          parameterType: STRING
    outputDefinitions:
      parameters:
        Output:
          parameterType: STRING
deploymentSpec:
  executors:
    exec-etl-and-feast-op:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - etl_and_feast_op
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.5.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"\
          $0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef etl_and_feast_op(\n    minio_url: str,\n    redis_url: str,\n\
          \    access_key: str,\n    secret_key: str\n):\n    import os\n    import\
          \ pandas as pd\n    import numpy as np\n    from sklearn.datasets import\
          \ load_iris\n    import boto3\n    from io import BytesIO\n    from datetime\
          \ import datetime\n\n    # 1. \u041D\u0430\u0441\u0442\u0440\u043E\u0439\
          \u043A\u0430 \u043E\u043A\u0440\u0443\u0436\u0435\u043D\u0438\u044F\n  \
          \  os.environ[\"AWS_ENDPOINT_URL\"] = minio_url\n    os.environ[\"AWS_ACCESS_KEY_ID\"\
          ] = access_key\n    os.environ[\"AWS_SECRET_ACCESS_KEY\"] = secret_key\n\
          \    os.environ[\"AWS_REGION\"] = \"us-east-1\"\n\n    print(\"--- [Step\
          \ 1] Generating Data ---\")\n    iris = load_iris()\n    df = pd.DataFrame(iris.data,\
          \ columns=['sepal_length', 'sepal_width', 'petal_length', 'petal_width'])\n\
          \    df.columns = [c.replace(' ', '_') for c in df.columns]\n    df['target']\
          \ = iris.target\n    df['flower_id'] = np.arange(len(df))\n    df['event_timestamp']\
          \ = pd.Timestamp.now()\n\n    # 2. \u0421\u043E\u0445\u0440\u0430\u043D\u0435\
          \u043D\u0438\u0435 \u0432 MinIO (Offline Store)\n    s3 = boto3.client('s3',\
          \ endpoint_url=minio_url, aws_access_key_id=access_key, aws_secret_access_key=secret_key)\n\
          \    try:\n        s3.create_bucket(Bucket=\"feast-data\")\n    except Exception:\n\
          \        pass\n\n    out_buffer = BytesIO()\n    df.to_parquet(out_buffer,\
          \ index=False)\n    s3.put_object(Bucket=\"feast-data\", Key=\"iris.parquet\"\
          , Body=out_buffer.getvalue())\n    print(\"\u2705 Data saved to MinIO\"\
          )\n\n    # 3. \u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0430 Feast\
          \ \"\u043D\u0430 \u043B\u0435\u0442\u0443\"\n    # \u041C\u044B \u043F\u0435\
          \u0440\u0435\u0437\u0430\u043F\u0438\u0441\u044B\u0432\u0430\u0435\u043C\
          \ \u043A\u043E\u043D\u0444\u0438\u0433 \u0432\u043D\u0443\u0442\u0440\u0438\
          \ \u043A\u043E\u043D\u0442\u0435\u0439\u043D\u0435\u0440\u0430 \u043F\u0440\
          \u0430\u0432\u0438\u043B\u044C\u043D\u044B\u043C\u0438 \u0430\u0434\u0440\
          \u0435\u0441\u0430\u043C\u0438 \u043A\u043B\u0430\u0441\u0442\u0435\u0440\
          \u0430\n    repo_path = \"/app/feature_repo\"\n    yaml_content = f\"\"\"\
          \nproject: iris_project\nregistry: s3://feast-data/registry.db\nprovider:\
          \ local\nonline_store:\n    type: redis\n    connection_string: \"{redis_url}\"\
          \noffline_store:\n    type: file\n\"\"\"\n    with open(f\"{repo_path}/feature_store.yaml\"\
          , \"w\") as f:\n        f.write(yaml_content)\n\n    os.chdir(repo_path)\n\
          \n    # 4. Feast Apply & Materialize\n    print(\"--- [Step 2] Syncing to\
          \ Redis ---\")\n    if os.system(\"feast apply\") != 0: raise RuntimeError(\"\
          Feast Apply Failed\")\n\n    # \u041C\u0430\u0442\u0435\u0440\u0438\u0430\
          \u043B\u0438\u0437\u0443\u0435\u043C \u0434\u0430\u043D\u043D\u044B\u0435\
          \ (\u0438\u0437 S3 \u0432 Redis)\n    if os.system(f\"feast materialize-incremental\
          \ {datetime.now().isoformat()}\") != 0: \n        raise RuntimeError(\"\
          Materialize Failed\")\n\n    print(\"\u2705 Feast synced successfully\"\
          )\n\n"
        image: feast-trainer:v3
    exec-kserve-deploy-op:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - kserve_deploy_op
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.5.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"'  &&\
          \  python3 -m pip install --quiet --no-warn-script-location 'kubernetes'\
          \ && \"$0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef kserve_deploy_op(\n    model_uri: str,\n    model_name: str =\
          \ \"iris-classifier\",\n    namespace: str = \"kubeflow\"\n):\n    from\
          \ kubernetes import client, config\n    import json\n\n    print(f\"\U0001F680\
          \ Deploying {model_uri} to KServe...\")\n\n    config.load_incluster_config()\n\
          \    api = client.CustomObjectsApi()\n\n    # \u041C\u0430\u043D\u0438\u0444\
          \u0435\u0441\u0442 InferenceService (\u0430\u043D\u0430\u043B\u043E\u0433\
          \ Seldon Model)\n    isvc = {\n        \"apiVersion\": \"serving.kserve.io/v1beta1\"\
          ,\n        \"kind\": \"InferenceService\",\n        \"metadata\": {\n  \
          \          \"name\": model_name,\n            \"namespace\": namespace,\n\
          \            \"annotations\": {\n                \"sidecar.istio.io/inject\"\
          : \"false\" # \u0418\u043D\u043E\u0433\u0434\u0430 \u043D\u0443\u0436\u043D\
          \u043E \u043E\u0442\u043A\u043B\u044E\u0447\u0430\u0442\u044C, \u0435\u0441\
          \u043B\u0438 \u043A\u043E\u043D\u0444\u043B\u0438\u043A\u0442\u044B\n  \
          \          }\n        },\n        \"spec\": {\n            \"predictor\"\
          : {\n                \"serviceAccountName\": \"kserve-sa\", # \u041D\u0430\
          \u0448 SA \u0441 \u0434\u043E\u0441\u0442\u0443\u043F\u043E\u043C \u043A\
          \ MinIO\n                \"model\": {\n                    \"modelFormat\"\
          : {\n                        \"name\": \"sklearn\" # \u0418\u0441\u043F\u043E\
          \u043B\u044C\u0437\u0443\u0435\u043C \u0441\u0442\u0430\u043D\u0434\u0430\
          \u0440\u0442\u043D\u044B\u0439 sklearn \u0441\u0435\u0440\u0432\u0435\u0440\
          \ KServe\n                    },\n                    \"storageUri\": model_uri\
          \ # s3://mlflow/...\n                }\n            }\n        }\n    }\n\
          \n    try:\n        # \u041F\u044B\u0442\u0430\u0435\u043C\u0441\u044F \u0441\
          \u043E\u0437\u0434\u0430\u0442\u044C\n        api.create_namespaced_custom_object(\n\
          \            group=\"serving.kserve.io\",\n            version=\"v1beta1\"\
          ,\n            namespace=namespace,\n            plural=\"inferenceservices\"\
          ,\n            body=isvc\n        )\n        print(\"\u2705 InferenceService\
          \ created!\")\n    except client.exceptions.ApiException as e:\n       \
          \ if e.status == 409: # \u0423\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\
          \u0442\u0432\u0443\u0435\u0442 -> \u043E\u0431\u043D\u043E\u0432\u043B\u044F\
          \u0435\u043C\n            print(\"\U0001F504 InferenceService exists, patching...\"\
          )\n            # \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C resourceVersion\
          \ \u0434\u043B\u044F \u043A\u043E\u0440\u0440\u0435\u043A\u0442\u043D\u043E\
          \u0433\u043E \u043F\u0430\u0442\u0447\u0430 (\u0438\u043B\u0438 \u0438\u0441\
          \u043F\u043E\u043B\u044C\u0437\u0443\u0435\u043C merge-patch)\n        \
          \    existing = api.get_namespaced_custom_object(\n                group=\"\
          serving.kserve.io\",\n                version=\"v1beta1\",\n           \
          \     namespace=namespace,\n                plural=\"inferenceservices\"\
          ,\n                name=model_name\n            )\n            isvc[\"metadata\"\
          ][\"resourceVersion\"] = existing[\"metadata\"][\"resourceVersion\"]\n\n\
          \            api.replace_namespaced_custom_object(\n                group=\"\
          serving.kserve.io\",\n                version=\"v1beta1\",\n           \
          \     namespace=namespace,\n                plural=\"inferenceservices\"\
          ,\n                name=model_name,\n                body=isvc\n       \
          \     )\n            print(\"\u2705 InferenceService updated!\")\n     \
          \   else:\n            raise e\n\n"
        image: python:3.9
    exec-train-op:
      container:
        args:
        - --executor_input
        - '{{$}}'
        - --function_to_execute
        - train_op
        command:
        - sh
        - -c
        - "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip ||\
          \ python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1\
          \ python3 -m pip install --quiet --no-warn-script-location 'kfp==2.5.0'\
          \ '--no-deps' 'typing-extensions>=3.7.4,<5; python_version<\"3.9\"' && \"\
          $0\" \"$@\"\n"
        - sh
        - -ec
        - 'program_path=$(mktemp -d)


          printf "%s" "$0" > "$program_path/ephemeral_component.py"

          _KFP_RUNTIME=true python3 -m kfp.dsl.executor_main                         --component_module_path                         "$program_path/ephemeral_component.py"                         "$@"

          '
        - "\nimport kfp\nfrom kfp import dsl\nfrom kfp.dsl import *\nfrom typing import\
          \ *\n\ndef train_op(\n    minio_url: str,\n    mlflow_url: str,\n    access_key:\
          \ str,\n    secret_key: str\n) -> str: # \u0412\u043E\u0437\u0432\u0440\u0430\
          \u0449\u0430\u0435\u0442 URI \u043C\u043E\u0434\u0435\u043B\u0438 (s3://...)\n\
          \    import os\n    import pandas as pd\n    import numpy as np\n    import\
          \ mlflow\n    import mlflow.sklearn\n    from sklearn.ensemble import RandomForestClassifier\n\
          \    from sklearn.model_selection import train_test_split\n    from sklearn.metrics\
          \ import accuracy_score\n    from mlflow.models.signature import infer_signature\n\
          \    from feast import FeatureStore\n\n    # Env setup\n    os.environ[\"\
          AWS_ENDPOINT_URL\"] = minio_url\n    os.environ[\"AWS_ACCESS_KEY_ID\"] =\
          \ access_key\n    os.environ[\"AWS_SECRET_ACCESS_KEY\"] = secret_key\n \
          \   os.environ[\"MLFLOW_S3_ENDPOINT_URL\"] = minio_url\n    os.environ[\"\
          MLFLOW_S3_IGNORE_TLS\"] = \"true\"\n    os.environ[\"AWS_REGION\"] = \"\
          us-east-1\"\n    os.system(\"pip install scikit-learn==1.3.2 mlflow==2.8.1\
          \ 'pydantic<2.0.0' numpy<2.0.0\")\n    # Feast Config (Offline only)\n \
          \   repo_path = \"/app/feature_repo\"\n    yaml_content = f\"\"\"\nproject:\
          \ iris_project\nregistry: s3://feast-data/registry.db\nprovider: local\n\
          offline_store:\n    type: file\n\"\"\"\n    with open(f\"{repo_path}/feature_store.yaml\"\
          , \"w\") as f:\n        f.write(yaml_content)\n\n    fs = FeatureStore(repo_path=repo_path)\n\
          \n    # 1. \u041F\u043E\u043B\u0443\u0447\u0435\u043D\u0438\u0435 \u0434\
          \u0430\u043D\u043D\u044B\u0445 \u0447\u0435\u0440\u0435\u0437 Feast\n  \
          \  print(\"--- [Step 3] Fetching Training Data ---\")\n    entity_df = pd.DataFrame.from_dict({\n\
          \        \"flower_id\": np.arange(150),\n        \"event_timestamp\": [pd.Timestamp.now()]\
          \ * 150\n    })\n\n    df = fs.get_historical_features(\n        entity_df=entity_df,\n\
          \        features=[\n            \"iris_stats:sepal_length\",\n        \
          \    \"iris_stats:sepal_width\",\n            \"iris_stats:petal_length\"\
          ,\n            \"iris_stats:petal_width\",\n            \"iris_stats:target\"\
          ,\n        ],\n    ).to_df().dropna()\n\n    X = df[['sepal_length', 'sepal_width',\
          \ 'petal_length', 'petal_width']].astype(np.float32)\n    y = df['target']\n\
          \    X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2,\
          \ random_state=42)\n\n    # 2. MLflow Training\n    print(\"--- [Step 4]\
          \ Training Model ---\")\n    mlflow.set_tracking_uri(mlflow_url)\n    mlflow.set_experiment(\"\
          kserve-experiment\")\n\n    model_name = \"IrisKServeModel\"\n    with mlflow.start_run()\
          \ as run:\n        clf = RandomForestClassifier(n_estimators=50)\n     \
          \   clf.fit(X_train, y_train)\n\n        acc = accuracy_score(y_test, clf.predict(X_test))\n\
          \        mlflow.log_metric(\"accuracy\", acc)\n\n        signature = infer_signature(X_train,\
          \ clf.predict(X_train))\n        mlflow.sklearn.log_model(clf, artifact_path=\"\
          model\", registered_model_name=model_name, signature=signature)\n\n    \
          \    # \u041F\u043E\u043B\u0443\u0447\u0430\u0435\u043C URI \u043C\u043E\
          \u0434\u0435\u043B\u0438 (s3://mlflow/...)\n        model_uri = mlflow.get_artifact_uri(\"\
          model\")\n        print(f\"\u2705 Model saved at {model_uri}\")\n      \
          \  return model_uri\n\n"
        image: feast-trainer:v3
pipelineInfo:
  description: Feast -> MLflow -> KServe
  name: kserve-mlops-pipeline
root:
  dag:
    tasks:
      etl-and-feast-op:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-etl-and-feast-op
        inputs:
          parameters:
            access_key:
              runtimeValue:
                constant: minio
            minio_url:
              runtimeValue:
                constant: http://minio-service.kubeflow.svc.cluster.local:9000
            redis_url:
              runtimeValue:
                constant: redis-master.kubeflow.svc.cluster.local:6379
            secret_key:
              runtimeValue:
                constant: minio123
        taskInfo:
          name: etl-and-feast-op
      kserve-deploy-op:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-kserve-deploy-op
        dependentTasks:
        - train-op
        inputs:
          parameters:
            model_name:
              runtimeValue:
                constant: iris-model
            model_uri:
              taskOutputParameter:
                outputParameterKey: Output
                producerTask: train-op
            namespace:
              runtimeValue:
                constant: kubeflow
        taskInfo:
          name: kserve-deploy-op
      train-op:
        cachingOptions:
          enableCache: true
        componentRef:
          name: comp-train-op
        dependentTasks:
        - etl-and-feast-op
        inputs:
          parameters:
            access_key:
              runtimeValue:
                constant: minio
            minio_url:
              runtimeValue:
                constant: http://minio-service.kubeflow.svc.cluster.local:9000
            mlflow_url:
              runtimeValue:
                constant: http://mlflow.kubeflow.svc.cluster.local:5000
            secret_key:
              runtimeValue:
                constant: minio123
        taskInfo:
          name: train-op
schemaVersion: 2.1.0
sdkVersion: kfp-2.5.0
